local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LP = Players.LocalPlayer
local Enabled = true
local Cache = {}

local COLORS = {
    Common = Color3.fromRGB(255, 255, 255),
    Uncommon = Color3.fromRGB(99, 255, 52),
    Rare = Color3.fromRGB(51, 170, 255),
    Epic = Color3.fromRGB(237, 44, 255),
    Legendary = Color3.fromRGB(255, 150, 0),
    Omega = Color3.fromRGB(255, 20, 51)
}

local function GetName(t)
    local a = t:GetAttribute("ItemName") or t:GetAttribute("DisplayName")
    if a and tostring(a) ~= "" and not tonumber(tostring(a)) then 
        return tostring(a) 
    end
    if tonumber(t.Name) then
        local v = t:FindFirstChild("Name") or t:FindFirstChild("ItemName")
        if v and v:IsA("StringValue") then return v.Value end
        return "Objet"
    end
    return t.Name
end

local function Update(p)
    local b = Cache[p]
    if not b then return end
    local c = b:FindFirstChild("Container")
    if not c then return end
    c:ClearAllChildren()
    
    local l = Instance.new("UIListLayout", c)
    l.FillDirection = Enum.FillDirection.Horizontal
    l.HorizontalAlignment = Enum.HorizontalAlignment.Center
    l.Padding = UDim.new(0, 5)

    local items = {}
    if p.Character then
        for _, o in ipairs(p.Character:GetChildren()) do
            if o:IsA("Tool") and o.Name ~= "Fists" then table.insert(items, o) end
        end
    end
    local bp = p:FindFirstChild("Backpack")
    if bp then
        for _, o in ipairs(bp:GetChildren()) do
            if o:IsA("Tool") and o.Name ~= "Fists" then table.insert(items, o) end
        end
    end

    b.Enabled = Enabled and (#items > 0)
    for _, t in ipairs(items) do
        local txt = Instance.new("TextLabel", c)
        txt.Size = UDim2.new(0, 90, 0, 25)
        txt.BackgroundTransparency = 1
        txt.Text = GetName(t)
        local r = t:GetAttribute("RarityName") or t:GetAttribute("Rarity") or "Common"
        txt.TextColor3 = COLORS[r] or Color3.new(1,1,1)
        txt.Font = Enum.Font.GothamBold
        txt.TextScaled = true
        txt.TextStrokeTransparency = 0.5
    end
end

local function Create(p)
    if p == LP then return end
    local function setup(char)
        local hrp = char:WaitForChild("HumanoidRootPart", 10)
        if not hrp then return end
        if Cache[p] then Cache[p]:Destroy() end
        local b = Instance.new("BillboardGui", hrp)
        b.Name = "ItemESP"
        b.Size = UDim2.new(0, 300, 0, 40)
        b.StudsOffset = Vector3.new(0, -4.5, 0)
        b.AlwaysOnTop = true
        local c = Instance.new("Frame", b)
        c.Name = "Container"
        c.Size = UDim2.new(1, 0, 1, 0)
        c.BackgroundTransparency = 1
        Cache[p] = b
        task.spawn(function()
            while char.Parent and b.Parent do
                Update(p)
                task.wait(1)
            end
        end)
    end
    p.CharacterAdded:Connect(setup)
    if p.Character then task.spawn(setup, p.Character) end
end

for _, p in ipairs(Players:GetPlayers()) do Create(p) end
Players.PlayerAdded:Connect(Create)

local sg = Instance.new("ScreenGui", LP.PlayerGui)
local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 80, 0, 30)
btn.Position = UDim2.new(0, 10, 0, 10)
btn.Text = "ESP ITEMS"
btn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
btn.MouseButton1Click:Connect(function()
    Enabled = not Enabled
    btn.BackgroundColor3 = Enabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
end)
