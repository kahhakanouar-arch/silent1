local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local ItemESP_Enabled = true

local BillboardCache = {}
local ItemESP_UpdateConnections = {}

local RARITY_COLORS = {
    ["Common"] = Color3.fromRGB(255, 255, 255),
    ["Uncommon"] = Color3.fromRGB(99, 255, 52),
    ["Rare"] = Color3.fromRGB(51, 170, 255),
    ["Epic"] = Color3.fromRGB(237, 44, 255),
    ["Legendary"] = Color3.fromRGB(255, 150, 0),
    ["Omega"] = Color3.fromRGB(255, 20, 51),
}

local function getToolColor(tool)
    local rarity = tool:GetAttribute("RarityName") 
               or tool:GetAttribute("Rarity") 
               or "Common"
    return RARITY_COLORS[rarity] or Color3.fromRGB(180, 180, 180)
end

local function updateESP(player)
    local bb = BillboardCache[player]
    if not bb then return end

    bb.Enabled = ItemESP_Enabled

    local container = bb:FindFirstChild("EspContainer")
    if not container then return end

    container:ClearAllChildren()

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Horizontal
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.VerticalAlignment = Enum.VerticalAlignment.Center
    layout.Padding = UDim.new(0, 5)
    layout.Parent = container

    local tools = {}
    local char = player.Character
    if char then
        for _, c in ipairs(char:GetChildren()) do
            if c:IsA("Tool") and c.Name ~= "Fists" and c.Name ~= "" then
                table.insert(tools, c)
            end
        end
        local bp = player:FindFirstChild("Backpack")
        if bp then
            for _, c in ipairs(bp:GetChildren()) do
                if c:IsA("Tool") and c.Name ~= "Fists" and c.Name ~= "" then
                    table.insert(tools, c)
                end
            end
        end
    end

    if #tools == 0 then return end

    for _, tool in ipairs(tools) do
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(0, 85, 0, 26)
        lbl.BackgroundTransparency = 1
        lbl.Text = tool.Name
        lbl.TextColor3 = getToolColor(tool)
        lbl.TextScaled = true
        lbl.Font = Enum.Font.Gotham
        lbl.TextStrokeTransparency = 0.65
        lbl.TextStrokeColor3 = Color3.new(0,0,0)
        lbl.TextTransparency = 0.05
        lbl.Parent = container
    end
end

local function createBillboard(player)
    if player == LocalPlayer or BillboardCache[player] then return end

    local conns = {}

    local function setup()
        local char = player.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        if BillboardCache[player] then BillboardCache[player]:Destroy() end

        local bb = Instance.new("BillboardGui")
        bb.Name = "ItemESP"
        bb.Adornee = hrp
        bb.Size = UDim2.new(0, 320, 0, 32)
        bb.StudsOffset = Vector3.new(0, -4.3, 0)
        bb.AlwaysOnTop = true
        bb.LightInfluence = 0
        bb.MaxDistance = 110
        bb.Enabled = ItemESP_Enabled
        bb.Parent = hrp

        local cont = Instance.new("Frame")
        cont.Name = "EspContainer"
        cont.Size = UDim2.new(1,0,1,0)
        cont.BackgroundTransparency = 1
        cont.Parent = bb

        BillboardCache[player] = bb

        local upd = function() updateESP(player) end
        upd()

        if char then
            table.insert(conns, char.ChildAdded:Connect(function(c) if c:IsA("Tool") then task.delay(0.1, upd) end end))
            table.insert(conns, char.ChildRemoved:Connect(function(c) if c:IsA("Tool") then task.delay(0.1, upd) end end))
        end

        local bp = player:FindFirstChild("Backpack")
        if bp then
            table.insert(conns, bp.ChildAdded:Connect(upd))
            table.insert(conns, bp.ChildRemoved:Connect(upd))
        end
    end

    if player.Character then task.spawn(setup) end
    table.insert(conns, player.CharacterAdded:Connect(function() task.wait(0.3) setup() end))

    ItemESP_UpdateConnections[player] = conns
end

for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then createBillboard(p) end
end

Players.PlayerAdded:Connect(function(p)
    if p ~= LocalPlayer then createBillboard(p) end
end)

Players.PlayerRemoving:Connect(function(p)
    if BillboardCache[p] then BillboardCache[p]:Destroy() BillboardCache[p] = nil end
    if ItemESP_UpdateConnections[p] then
        for _, c in pairs(ItemESP_UpdateConnections[p]) do if c.Connected then c:Disconnect() end end
        ItemESP_UpdateConnections[p] = nil
    end
end)

-- Petit bouton toggle
local sg = Instance.new("ScreenGui")
sg.Name = "ItemESP_Toggle"
sg.ResetOnSpawn = false
sg.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 75, 0, 28)
frame.Position = UDim2.new(0.01, 0, 0.01, 0)
frame.BackgroundColor3 = Color3.fromRGB(22, 22, 22)
frame.BorderSizePixel = 0

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 5)

local btn = Instance.new("TextButton", frame)
btn.Size = UDim2.new(1, -4, 1, -4)
btn.Position = UDim2.new(0, 2, 0, 2)
btn.BackgroundColor3 = Color3.fromRGB(0, 120, 0)
btn.Text = "Items"
btn.TextColor3 = Color3.new(1,1,1)
btn.TextScaled = true
btn.Font = Enum.Font.Gotham
btn.BorderSizePixel = 0

Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)

local dragging, dragStart, startPos = false, nil, nil

frame.InputBegan:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = inp.Position
        startPos = frame.Position
        inp.Changed:Connect(function()
            if inp.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(inp)
    if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = inp.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

btn.MouseButton1Click:Connect(function()
    ItemESP_Enabled = not ItemESP_Enabled
    btn.BackgroundColor3 = ItemESP_Enabled and Color3.fromRGB(0,120,0) or Color3.fromRGB(120,0,0)
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then updateESP(p) end
    end
end)

print("Item ESP sous les pieds - OK avec attribut Rarity")
