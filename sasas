local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local ItemESP_Enabled = true
local BillboardCache = {}
local nameCache = {} 

-- Tes couleurs de rareté
local RARITY_COLORS = {
    ["Common"] = Color3.fromRGB(255, 255, 255),
    ["Uncommon"] = Color3.fromRGB(99, 255, 52),
    ["Rare"] = Color3.fromRGB(51, 170, 255),
    ["Epic"] = Color3.fromRGB(237, 44, 255),
    ["Legendary"] = Color3.fromRGB(255, 150, 0),
    ["Omega"] = Color3.fromRGB(255, 20, 51),
}

-- Fonction pour nettoyer le nom et identifier l'arme
local function getRealWeaponName(tool)
    if nameCache[tool.Name] then return nameCache[tool.Name] end
    
    -- On retire les chiffres (IDs)
    local cleanName = tool.Name:gsub("%d+", ""):gsub("%s+", " "):match("^%s*(.-)%s*$")
    
    -- On vérifie les attributs
    local attr = tool:GetAttribute("ItemName") or tool:GetAttribute("DisplayName")
    if attr and not tonumber(tostring(attr)) then return tostring(attr) end

    -- Comparaison profonde avec ReplicatedStorage pour Hunting Rifle, Draco, etc.
    local handle = tool:FindFirstChild("Handle")
    if handle then
        local children = {}
        for _, c in ipairs(handle:GetChildren()) do children[c.Name] = true end
        local itemsFolder = ReplicatedStorage:FindFirstChild("Items")
        if itemsFolder then
            for _, item in ipairs(itemsFolder:GetDescendants()) do
                if item:IsA("Tool") and item:FindFirstChild("Handle") then
                    local match = true
                    for n in pairs(children) do
                        if not item.Handle:FindFirstChild(n) then match = false break end
                    end
                    if match then 
                        nameCache[tool.Name] = item.Name 
                        return item.Name 
                    end
                end
            end
        end
    end
    
    return (cleanName ~= "" and cleanName ~= "Tool") and cleanName or nil
end

local function updateESP(player)
    local bb = BillboardCache[player]
    if not bb then return end
    local container = bb:FindFirstChild("EspContainer")
    if not container then return end
    container:ClearAllChildren()

    local layout = Instance.new("UIListLayout", container)
    layout.FillDirection = Enum.FillDirection.Horizontal
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Padding = UDim.new(0, 3)

    local tools = {}
    if player.Character then
        for _, c in ipairs(player.Character:GetChildren()) do
            -- BLOQUE FISTS (Poings)
            if c:IsA("Tool") and c.Name:lower() ~= "fists" then table.insert(tools, c) end
        end
        local bp = player:FindFirstChild("Backpack")
        if bp then
            for _, c in ipairs(bp:GetChildren()) do
                if c:IsA("Tool") and c.Name:lower() ~= "fists" then table.insert(tools, c) end
            end
        end
    end

    bb.Enabled = ItemESP_Enabled and (#tools > 0)
    for _, tool in ipairs(tools) do
        local name = getRealWeaponName(tool)
        
        -- On n'affiche que si c'est un nom valide et pas "Fists"
        if name and name:lower() ~= "fists" then 
            local rarity = tool:GetAttribute("RarityName") or tool:GetAttribute("Rarity") or "Common"
            local lbl = Instance.new("TextLabel", container)
            
            -- Taille petite et fixe pour tout le monde
            lbl.Size = UDim2.new(0, 50, 0, 14) 
            lbl.BackgroundTransparency = 1
            lbl.Text = name
            lbl.TextColor3 = RARITY_COLORS[rarity] or Color3.new(1,1,1)
            lbl.Font = Enum.Font.SourceSansBold
            lbl.TextSize = 10 
            lbl.TextStrokeTransparency = 0.6
        end
    end
end

local function createESP(player)
    if player == LocalPlayer then return end
    local function setup(char)
        local hrp = char:WaitForChild("HumanoidRootPart", 10)
        if not hrp then return end
        
        if BillboardCache[player] then BillboardCache[player]:Destroy() end
        local bb = Instance.new("BillboardGui", hrp)
        bb.Name = "WeaponESP_V4"
        bb.Size = UDim2.new(0, 160, 0, 20)
        bb.StudsOffset = Vector3.new(0, -4.5, 0) -- Sous les pieds
        bb.AlwaysOnTop = true
        
        local cont = Instance.new("Frame", bb)
        cont.Name = "EspContainer"
        cont.Size = UDim2.new(1,0,1,0)
        cont.BackgroundTransparency = 1
        BillboardCache[player] = bb

        task.spawn(function()
            while char.Parent and bb.Parent do
                updateESP(player)
                task.wait(1.5)
            end
        end)
    end
    player.CharacterAdded:Connect(setup)
    if player.Character then setup(player.Character) end
end

for _, p in ipairs(Players:GetPlayers()) do createESP(p) end
Players.PlayerAdded:Connect(createESP)
