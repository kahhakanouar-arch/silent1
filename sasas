local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local ItemESP_Enabled = true
local BillboardCache = {}

local RARITY_COLORS = {
    ["Common"] = Color3.fromRGB(255, 255, 255),
    ["Uncommon"] = Color3.fromRGB(99, 255, 52),
    ["Rare"] = Color3.fromRGB(51, 170, 255),
    ["Epic"] = Color3.fromRGB(237, 44, 255),
    ["Legendary"] = Color3.fromRGB(255, 150, 0),
    ["Omega"] = Color3.fromRGB(255, 20, 51),
}

-- Fonction ultra-précise pour choper le nom dans BlockSpin
local function getRealName(tool)
    -- 1. Test des Attributes (très courant dans BlockSpin) [cite: 1, 2]
    local attr = tool:GetAttribute("ItemName") or tool:GetAttribute("DisplayName") or tool:GetAttribute("Rarity")
    if attr and tostring(attr) ~= "" and not tonumber(tostring(attr)) then 
        return tostring(attr) 
    end

    -- 2. Test des StringValues internes
    for _, v in ipairs(tool:GetChildren()) do
        if v:IsA("StringValue") and v.Name:lower():find("name") then
            return v.Value
        end
    end

    -- 3. Si le nom est un chiffre, on renvoie "Chargement..." au lieu du chiffre
    if tonumber(tool.Name) then
        return "Equipped Item"
    end

    return tool.Name
end

local function updateESP(player)
    local bb = BillboardCache[player]
    if not bb or not ItemESP_Enabled then 
        if bb then bb.Enabled = false end
        return 
    end

    local container = bb:FindFirstChild("EspContainer")
    if not container then return end
    container:ClearAllChildren()

    local layout = Instance.new("UIListLayout", container)
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Padding = UDim.new(0, 2)

    local foundTools = {}
    
    -- Check Character (Equipé) [cite: 3]
    if player.Character then
        for _, obj in ipairs(player.Character:GetChildren()) do
            if obj:IsA("Tool") and obj.Name ~= "Fists" then
                table.insert(foundTools, obj)
            end
        end
    end

    -- Check Backpack (Inventaire) [cite: 4]
    local bp = player:FindFirstChild("Backpack")
    if bp then
        for _, obj in ipairs(bp:GetChildren()) do
            if obj:IsA("Tool") and obj.Name ~= "Fists" then
                table.insert(foundTools, obj)
            end
        end
    end

    for _, tool in ipairs(foundTools) do
        local name = getRealName(tool)
        local lbl = Instance.new("TextLabel", container)
        lbl.Size = UDim2.new(0, 120, 0, 20)
        lbl.BackgroundTransparency = 1
        lbl.Text = name
        lbl.TextColor3 = RARITY_COLORS[tool:GetAttribute("Rarity")] or Color3.new(1,1,1)
        lbl.Font = Enum.Font.GothamBold
        lbl.TextScaled = true
        lbl.TextStrokeTransparency = 0
    end
    
    bb.Enabled = (#foundTools > 0)
end

local function createESP(player)
    if player == LocalPlayer then return end

    local function setup(char)
        local hrp = char:WaitForChild("HumanoidRootPart", 10)
        if not hrp then return end

        local bb = Instance.new("BillboardGui")
        bb.Name = "BlockSpinESP"
        bb.Adornee = hrp
        bb.Size = UDim2.new(0, 200, 0, 100)
        bb.AlwaysOnTop = true
        bb.StudsOffset = Vector3.new(0, 3, 0) -- On le met AU DESSUS de la tête pour être sûr de le voir
        bb.Parent = hrp
        
        local cont = Instance.new("Frame", bb)
        cont.Name = "EspContainer"
        cont.Size = UDim2.new(1, 0, 1, 0)
        cont.BackgroundTransparency = 1

        BillboardCache[player] = bb
        
        -- Boucle de rafraîchissement automatique
        task.spawn(function()
            while char.Parent and bb.Parent do
                updateESP(player)
                task.wait(1) -- Rafraîchit toutes les secondes
            end
        end)
    end

    if player.Character then setup(player.Character) end
    player.CharacterAdded:Connect(setup)
end

-- Lancement
for _, p in ipairs(Players:GetPlayers()) do createESP(p) end
Players.PlayerAdded:Connect(createESP)

-- Toggle Simple
local sg = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 100, 0, 40)
btn.Position = UDim2.new(0, 10, 0, 50)
btn.Text = "TOGGLE ESP"
btn.BackgroundColor3 = Color3.new(0, 0.5, 1)

btn.MouseButton1Click:Connect(function()
    ItemESP_Enabled = not ItemESP_Enabled
    btn.BackgroundColor3 = ItemESP_Enabled and Color3.new(0, 0.5, 1) or Color3.new(1, 0, 0)
end)
