local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local ItemESP_Enabled = true

local BillboardCache = {}
local ItemESP_UpdateConnections = {}

local RARITY_COLORS = {
    ["Common"] = Color3.fromRGB(255, 255, 255),
    ["Uncommon"] = Color3.fromRGB(99, 255, 52),
    ["Rare"] = Color3.fromRGB(51, 170, 255),
    ["Epic"] = Color3.fromRGB(237, 44, 255),
    ["Legendary"] = Color3.fromRGB(255, 150, 0),
    ["Omega"] = Color3.fromRGB(255, 20, 51),
}

-- Tentative de récupération du nom par toutes les méthodes possibles
local function getToolName(tool)
    local attrName = tool:GetAttribute("ItemName") or tool:GetAttribute("DisplayName") or tool:GetAttribute("Name") [cite: 2]
    if attrName and tostring(attrName) ~= "" then
        return tostring(attrName)
    end
    
    -- Si c'est un chiffre, on cherche un StringValue à l'intérieur
    local nameVal = tool:FindFirstChild("Name") or tool:FindFirstChild("ItemName")
    if nameVal and nameVal:IsA("StringValue") then
        return nameVal.Value
    end

    return tool.Name -- Retour par défaut [cite: 5]
end

local function getToolColor(tool)
    local rarity = tool:GetAttribute("RarityName") or tool:GetAttribute("Rarity") or "Common" [cite: 2]
    return RARITY_COLORS[rarity] or Color3.fromRGB(180, 180, 180)
end

local function updateESP(player)
    local bb = BillboardCache[player]
    if not bb then return end

    bb.Enabled = ItemESP_Enabled
    local container = bb:FindFirstChild("EspContainer")
    if not container then return end

    container:ClearAllChildren()

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Horizontal
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.VerticalAlignment = Enum.VerticalAlignment.Center
    layout.Padding = UDim.new(0, 5)
    layout.Parent = container [cite: 3]

    local tools = {}
    local char = player.Character
    if char then
        for _, c in ipairs(char:GetChildren()) do
            if c:IsA("Tool") and c.Name ~= "Fists" then [cite: 3]
                table.insert(tools, c)
            end
        end
        local bp = player:FindFirstChild("Backpack") [cite: 4]
        if bp then
            for _, c in ipairs(bp:GetChildren()) do
                if c:IsA("Tool") and c.Name ~= "Fists" then [cite: 4]
                    table.insert(tools, c)
                end
            end
        end
    end

    if #tools == 0 then return end

    for _, tool in ipairs(tools) do
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(0, 100, 0, 30)
        lbl.BackgroundTransparency = 1
        lbl.Text = getToolName(tool)
        lbl.TextColor3 = getToolColor(tool)
        lbl.TextScaled = true
        lbl.Font = Enum.Font.GothamBold [cite: 6]
        lbl.TextStrokeTransparency = 0.5
        lbl.TextStrokeColor3 = Color3.new(0,0,0)
        lbl.Parent = container
    end
end

local function createBillboard(player)
    if player == LocalPlayer or BillboardCache[player] then return end

    local conns = {}

    local function setup()
        local char = player.Character
        if not char then return end
        local hrp = char:WaitForChild("HumanoidRootPart", 5)
        if not hrp then return end

        if BillboardCache[player] then BillboardCache[player]:Destroy() end

        local bb = Instance.new("BillboardGui")
        bb.Name = "ItemESP"
        bb.Adornee = hrp
        bb.Size = UDim2.new(0, 400, 0, 50)
        bb.StudsOffset = Vector3.new(0, -5, 0) -- Un peu plus bas sous les pieds 
        bb.AlwaysOnTop = true
        bb.MaxDistance = 500 -- Augmenté pour voir de loin 
        bb.Enabled = ItemESP_Enabled
        bb.Parent = hrp

        local cont = Instance.new("Frame")
        cont.Name = "EspContainer"
        cont.Size = UDim2.new(1,0,1,0)
        cont.BackgroundTransparency = 1
        cont.Parent = bb [cite: 9]

        BillboardCache[player] = bb
        updateESP(player)

        table.insert(conns, char.ChildAdded:Connect(function() task.wait(0.1) updateESP(player) end))
        table.insert(conns, char.ChildRemoved:Connect(function() task.wait(0.1) updateESP(player) end))
        
        local bp = player:WaitForChild("Backpack", 5) [cite: 10]
        if bp then
            table.insert(conns, bp.ChildAdded:Connect(function() updateESP(player) end))
            table.insert(conns, bp.ChildRemoved:Connect(function() updateESP(player) end))
        end
    end

    if player.Character then task.spawn(setup) end
    table.insert(conns, player.CharacterAdded:Connect(function() task.wait(0.5) setup() end))
    ItemESP_UpdateConnections[player] = conns
end

-- Initialisation
for _, p in ipairs(Players:GetPlayers()) do createBillboard(p) end
Players.PlayerAdded:Connect(createBillboard)

-- Toggle Button
local sg = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 80, 0, 30)
btn.Position = UDim2.new(0, 10, 0, 10)
btn.Text = "ESP ITEMS"
btn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)

btn.MouseButton1Click:Connect(function()
    ItemESP_Enabled = not ItemESP_Enabled
    btn.BackgroundColor3 = ItemESP_Enabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    for _, p in ipairs(Players:GetPlayers()) do updateESP(p) end
end)
