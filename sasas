-- === DROP WEAPONS ONLY ESP (GOLD) - FIX BUG MAIN Ã‰QUIPÃ‰E ===
-- Seulement armes droppÃ©es au sol (pas en main de joueur)
-- GOLD pour tout | Toggle: INSERT | Auto Pickup: RIGHT SHIFT
-- Moins de lag : scan workspace:GetChildren() + check prÃ©cis

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer

local GOLD_COLOR = Color3.fromRGB(255, 215, 0)  -- Or Legendary

local ESP_ENABLED = true
local AUTO_PICKUP = false
local MAX_DIST = 300
local ESPs = {}

-- Mots pour armes (ajoute si besoin nouveaux drops)
local WEAPON_KEYWORDS = {"ak", "ak47", "mp5", "rpg", "remi", "remington", "draco", "tact", "axe", "crossbow", "revolver", "glock", "db", "plasma"}

local function isDroppedWeapon(obj)
    if not obj then return false end
    
    local nameLower = obj.Name:lower()
    
    -- Doit matcher un mot-clÃ© arme
    local isWeaponName = false
    for _, kw in ipairs(WEAPON_KEYWORDS) do
        if nameLower:find(kw) then
            isWeaponName = true
            break
        end
    end
    if not isWeaponName then return false end
    
    -- Pas dans un joueur (pas dans Character)
    if obj:IsDescendantOf(LocalPlayer.Character) or obj:FindFirstAncestorWhichIsA("Model") and obj:FindFirstAncestorWhichIsA("Model"):FindFirstChildOfClass("Humanoid") then
        return false
    end
    
    -- Pas de Humanoid (exclut joueurs vivants)
    if obj:FindFirstChildOfClass("Humanoid") or obj.Parent:FindFirstChildOfClass("Humanoid") then
        return false
    end
    
    -- Doit Ãªtre Tool ou Model avec Handle/PrimaryPart
    if obj:IsA("Tool") or (obj:IsA("Model") and (obj:FindFirstChild("Handle") or obj.PrimaryPart)) then
        return true
    end
    
    return false
end

local function createESP(item)
    if ESPs[item] then return end
    
    local targetPart = item:FindFirstChild("Handle") or item.PrimaryPart or item:FindFirstChildWhichIsA("BasePart")
    if not targetPart then return end
    
    print("ðŸ”¥ DROP ARME DÃ‰TECTÃ‰E: " .. item.Name .. " â†’ GOLD ESP crÃ©Ã© !")
    
    local highlight = Instance.new("Highlight")
    highlight.FillColor = GOLD_COLOR
    highlight.OutlineColor = GOLD_COLOR
    highlight.FillTransparency = 0.35
    highlight.OutlineTransparency = 0
    highlight.Parent = item
    
    local bill = Instance.new("BillboardGui")
    bill.Adornee = targetPart
    bill.Size = UDim2.new(0, 220, 0, 50)
    bill.StudsOffset = Vector3.new(0, 3.5, 0)
    bill.AlwaysOnTop = true
    bill.Parent = targetPart
    
    local frame = Instance.new("Frame", bill)
    frame.Size = UDim2.new(1,0,1,0)
    frame.BackgroundColor3 = Color3.new(0,0,0)
    frame.BackgroundTransparency = 0.45
    
    local uc = Instance.new("UICorner", frame)
    uc.CornerRadius = UDim.new(0,6)
    
    local lbl = Instance.new("TextLabel", frame)
    lbl.Size = UDim2.new(1,0,1,0)
    lbl.BackgroundTransparency = 1
    lbl.Text = item.Name .. " [DROP]"
    lbl.TextColor3 = GOLD_COLOR
    lbl.TextScaled = true
    lbl.Font = Enum.Font.GothamBold
    
    ESPs[item] = {hl = highlight, bill = bill}
end

local function removeESP(item)
    if ESPs[item] then
        if ESPs[item].hl then ESPs[item].hl:Destroy() end
        if ESPs[item].bill then ESPs[item].bill:Destroy() end
        ESPs[item] = nil
    end
end

local function scanDrops()
    if not ESP_ENABLED then return end
    if not LocalPlayer.Character or not LocalPlayer.Character.PrimaryPart then return end
    
    local lpPos = LocalPlayer.Character.PrimaryPart.Position
    
    for _, obj in ipairs(workspace:GetChildren()) do  -- GetChildren() plus rapide que GetDescendants()
        if isDroppedWeapon(obj) then
            local part = obj:FindFirstChild("Handle") or obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
            if part then
                local dist = (lpPos - part.Position).Magnitude
                if dist <= MAX_DIST then
                    createESP(obj)
                else
                    removeESP(obj)
                end
            end
        elseif ESPs[obj] then  -- Cleanup si plus drop
            removeESP(obj)
        end
    end
end

RunService.Heartbeat:Connect(scanDrops)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Insert then
        ESP_ENABLED = not ESP_ENABLED
        print("DROP WEAPONS ESP: " .. (ESP_ENABLED and "ON (GOLD)" or "OFF"))
        if not ESP_ENABLED then
            for item,_ in pairs(ESPs) do removeESP(item) end
        end
    elseif input.KeyCode == Enum.KeyCode.RightShift then
        AUTO_PICKUP = not AUTO_PICKUP
        print("AUTO PICKUP DROPS: " .. (AUTO_PICKUP and "ON" or "OFF"))
    end
end)

-- Auto pickup simple (fire prompt si proche d'une arme drop)
spawn(function()
    while wait(0.2) do
        if not AUTO_PICKUP or not ESP_ENABLED then continue end
        for _, obj in ipairs(workspace:GetChildren()) do
            if isDroppedWeapon(obj) then
                local prompt = obj:FindFirstChildOfClass("ProximityPrompt") or obj:FindFirstChildWhichIsA("ProximityPrompt", true)
                if prompt then
                    local dist = (LocalPlayer.Character.PrimaryPart.Position - prompt.Parent.Position).Magnitude
                    if dist < 12 then
                        fireproximityprompt(prompt)
                        print("AUTO PICKUP: " .. obj.Name)
                    end
                end
            end
        end
    end
end)

print("=== DROP WEAPONS ONLY ESP (GOLD) - FIXED BUG MAIN ===")
print("Seulement armes au sol (pas Ã©quipÃ©es) | INSERT pour toggle | RIGHT SHIFT auto pickup")
print("Regarde F9 pour voir les dÃ©tections quand tu drop une arme !")
